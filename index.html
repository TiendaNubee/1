<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Chic Shopping - Tienda Online</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Tienda online de moda y accesorios">
  <style>
    :root {
      --primary: #25d366;
      --primary-dark: #128C7E;
      --secondary: #f5f5f5;
      --text: #333;
      --text-light: #666;
      --white: #fff;
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background: var(--secondary);
      color: var(--text);
      line-height: 1.5;
    }
    
    /* Header */
    header {
      position: relative;
      margin-bottom: 15px;
      box-shadow: var(--shadow);
    }
    
    #header {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: linear-gradient(45deg, #f3f3f3, #e0e0e0);
      display: block;
    }
    
    /* Categor√≠as */
    .categories {
      display: flex;
      gap: 10px;
      padding: 12px 15px;
      overflow-x: auto;
      background: var(--white);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      position: sticky;
      top: 0;
      z-index: 10;
      scrollbar-width: none; /* Firefox */
    }
    
    .categories::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Opera */
    }
    
    .cat {
      padding: 6px 16px;
      background: var(--secondary);
      border-radius: 20px;
      cursor: pointer;
      white-space: nowrap;
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      border: 1px solid #e0e0e0;
      transition: all 0.2s ease;
    }
    
    .cat.active {
      background: var(--primary);
      color: var(--white);
      border-color: var(--primary);
    }
    
    /* Productos */
    .products {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      padding: 15px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .card {
      background: var(--white);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .card:active {
      transform: scale(0.98);
    }
    
    .card img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      background: linear-gradient(45deg, #f5f5f5, #e0e0e0);
      display: block;
    }
    
    .info {
      padding: 12px;
    }
    
    .info h3 {
      font-size: 14px;
      margin-bottom: 6px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .price {
      color: var(--primary-dark);
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 8px;
    }
    
    .wsp {
      display: block;
      background: var(--primary);
      color: var(--white);
      text-align: center;
      padding: 8px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 500;
      font-size: 14px;
      transition: background 0.2s ease;
    }
    
    .wsp:hover, .wsp:active {
      background: var(--primary-dark);
    }
    
    .wsp i {
      margin-right: 5px;
    }
    
    /* Bot√≥n de admin */
    .admin {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background: var(--white);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      text-decoration: none;
      color: var(--text);
      font-size: 22px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      z-index: 100;
    }
    
    .admin:active {
      transform: scale(0.95);
    }
    
    /* Estado de carga */
    .loading {
      text-align: center;
      padding: 30px;
      grid-column: 1 / -1;
      color: var(--text-light);
    }
    
    /* Mensaje sin productos */
    .no-products {
      grid-column: 1 / -1;
      text-align: center;
      padding: 40px 20px;
      color: var(--text-light);
    }
    
    /* Responsive */
    @media (min-width: 640px) {
      .products {
        grid-template-columns: repeat(3, 1fr);
        padding: 20px;
      }
      
      .card img {
        height: 200px;
      }
    }
    
    @media (min-width: 1024px) {
      .products {
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        padding: 25px;
      }
      
      .card img {
        height: 220px;
      }
      
      .logo-upload {
        width: 100%;
        max-width: 400px;
        height: 200px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px dashed #ccc;
        border-radius: 8px;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        background-color: #f9f9f9;
      }
      
      .logo-upload:hover {
        border-color: #999;
        background-color: #f0f0f0;
      }
      
      .logo-placeholder {
        text-align: center;
        color: #666;
        font-size: 16px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      
      .plus-icon {
        font-size: 48px;
        font-weight: lighter;
        line-height: 1;
        margin-bottom: 10px;
      }
      
      .logo-text {
        font-size: 16px;
      }
      
      #header {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }
      
      .info h3 {
        font-size: 15px;
      }
    }
  </style>
</head>

<body>
  <div style="position: relative; width: 100%;">
    <a class="admin" href="#" onclick="showPasswordModal()" title="Panel de administraci√≥n" style="position: absolute; top: 15px; right: 15px; z-index: 1000; background: rgba(255, 255, 255, 0.9); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-decoration: none; font-size: 20px; cursor: pointer;">‚öôÔ∏è</a>
  </div>

  <!-- Modal de Contrase√±a -->
  <div id="passwordModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Acceso de Administrador</h2>
      <p>Por favor ingrese la contrase√±a para continuar:</p>
      <input type="password" id="adminPassword" placeholder="Contrase√±a" class="password-input">
      <button onclick="checkAdminPassword()" class="submit-btn">Ingresar</button>
      <p id="errorMsg" class="error-msg"></p>
    </div>
  </div>

  <style>
    /* Estilos del Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(3px);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: #fff;
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      position: relative;
      animation: modalFadeIn 0.3s ease-out;
    }

    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .close {
      position: absolute;
      right: 20px;
      top: 15px;
      color: #888;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.2s;
    }

    .close:hover {
      color: #333;
    }

    .modal h2 {
      margin-top: 0;
      color: #333;
      font-size: 1.5em;
      margin-bottom: 15px;
    }

    .password-input {
      width: 100%;
      padding: 12px 15px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
      transition: border-color 0.3s;
    }

    .password-input:focus {
      border-color: #25d366;
      outline: none;
      box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.2);
    }

    .submit-btn {
      background-color: #25d366;
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      width: 100%;
      margin-top: 10px;
      transition: background-color 0.3s, transform 0.1s;
    }

    .submit-btn:hover {
      background-color: #20bd5a;
    }

    .submit-btn:active {
      transform: translateY(1px);
    }

    .error-msg {
      color: #e74c3c;
      margin-top: 10px;
      min-height: 20px;
      font-size: 14px;
      text-align: center;
    }
  </style>

  <script>
    // Mostrar modal
    function showPasswordModal() {
      const modal = document.getElementById('passwordModal');
      modal.style.display = 'flex';
      document.getElementById('adminPassword').focus();
    }

    // Cerrar modal al hacer clic en la X
    document.querySelector('.close').addEventListener('click', function() {
      document.getElementById('passwordModal').style.display = 'none';
      document.getElementById('errorMsg').textContent = '';
      document.getElementById('adminPassword').value = '';
    });

    // Cerrar modal al hacer clic fuera del contenido
    window.onclick = function(event) {
      const modal = document.getElementById('passwordModal');
      if (event.target === modal) {
        modal.style.display = 'none';
        document.getElementById('errorMsg').textContent = '';
        document.getElementById('adminPassword').value = '';
      }
    }

    // Permitir presionar Enter para enviar
    document.getElementById('adminPassword').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        checkAdminPassword();
      }
    });

    // Verificar contrase√±a
    function checkAdminPassword() {
      const password = document.getElementById('adminPassword').value;
      const errorMsg = document.getElementById('errorMsg');
      
      if (password === 'Naty2026,3') {
        window.location.href = 'admin.html';
      } else {
        errorMsg.textContent = 'Contrase√±a incorrecta. Intente nuevamente.';
        document.getElementById('adminPassword').value = '';
        document.getElementById('adminPassword').focus();
      }
    }
  </script>
  <header>
    <div id="headerContainer">
      <img id="header" alt="">
    </div>
  </header>

  <div class="categories" id="cats">
    <!-- Categor√≠as se cargar√°n din√°micamente -->
  </div>

  <div class="products" id="products">
    <div class="loading">Cargando productos...</div>
  </div>

  <script type="module" src="app.js"></script>

  <script type="module">
    // Elementos del DOM
    const headerImg = document.getElementById("header");
    const catsDiv = document.getElementById("cats");
    const root = document.documentElement;

    // Funci√≥n para aplicar los colores a los elementos de la interfaz

    // Funci√≥n para ajustar el color (clarear u oscurecer seg√∫n sea necesario)
    function adjustColor(color, amount = 0) {
      // Si el color es muy oscuro, aclararlo; si es muy claro, oscurecerlo
      if (amount === 0) {
        const r = parseInt(color.slice(1,3), 16);
        const g = parseInt(color.slice(3,5), 16);
        const b = parseInt(color.slice(5,7), 16);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        amount = brightness > 155 ? -10 : 10;
      }
      
      // Ajustar el color seg√∫n la cantidad
      let usePound = false;
      if (color[0] === "#") {
        color = color.slice(1);
        usePound = true;
      }
      
      const num = parseInt(color, 16);
      
      let r = (num >> 16) + amount;
      if (r > 255) r = 255;
      else if (r < 0) r = 0;
      
      let g = (num & 0x0000FF) + amount;
      if (g > 255) g = 255;
      else if (g < 0) g = 0;
      
      let b = ((num >> 8) & 0x00FF) + amount;
      if (b > 255) b = 255;
      else if (b < 0) b = 0;
      
      return (usePound ? "#" : "") + (g | (b << 8) | (r << 16)).toString(16).padStart(6, '0');
    }
    
    // Funci√≥n para aplicar los colores a la interfaz
    function applyColors(colors) {
      console.log('Aplicando colores:', colors);
      
      try {
        // Aplicar color de fondo
        if (colors.bgColor) {
          // Aplicar al body
          document.body.style.backgroundColor = colors.bgColor;
          
          // Calcular contraste para el texto
          const textColor = getContrastColor(colors.bgColor);
          
          // Aplicar color de texto al body
          document.body.style.color = textColor;
          
          // Aplicar a las secciones
          const sections = document.querySelectorAll('section, .section, .card, .categories, .product, .product-detail');
          sections.forEach(section => {
            section.style.backgroundColor = colors.bgColor;
            section.style.color = textColor; // Asegurar contraste legible
          });
          
          // Aplicar a las tarjetas de productos y publicaciones
          const cards = document.querySelectorAll('.card, .publication, .post, .product, .item, .producto');
          const adjustedBgColor = adjustColor(colors.bgColor);
          
          cards.forEach(card => {
            // Estilos id√©nticos a los cuadros del admin
            card.style.backgroundColor = adjustedBgColor;
            card.style.borderRadius = '8px';
            card.style.padding = '15px';
            card.style.marginBottom = '20px';
            card.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
            card.style.border = 'none';
            card.style.transition = 'all 0.3s ease';
            
            // Obtener color de texto con buen contraste
            const textColor = getContrastColor(adjustedBgColor);
            
            // Aplicar estilos a los textos dentro de las tarjetas
            const textElements = card.querySelectorAll('p, h1, h2, h3, h4, h5, h6, span, div:not(.wsp):not(.price)');
            textElements.forEach(el => {
              if (!el.closest('button') && !el.closest('a')) {
                el.style.color = textColor;
              }
            });
            
            // Estilo para los precios (igual que en admin)
            const priceElements = card.querySelectorAll('.price, .product-price, .publication-price, .precio');
            priceElements.forEach(price => {
              price.style.color = colors.btnColor || '#25d366';
              price.style.fontWeight = 'bold';
              price.style.fontSize = '1.1em';
              price.style.margin = '10px 0';
            });
            
            // Efecto hover sutil como en admin
            card.onmouseover = () => {
              card.style.transform = 'translateY(-2px)';
              card.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)';
            };
            card.onmouseout = () => {
              card.style.transform = 'translateY(0)';
              card.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
            };
            
            // Asegurar que los botones dentro de las tarjetas mantengan su estilo
            const buttons = card.querySelectorAll('button, .btn, .wsp, .add-to-cart');
            buttons.forEach(button => {
              if (colors.btnColor) {
                const btnBgColor = button.classList.contains('wsp') ? '#25d366' : colors.btnColor;
                const btnTextColor = getContrastColor(btnBgColor);
                
                button.style.backgroundColor = btnBgColor;
                button.style.borderColor = shadeColor(btnBgColor, -15);
                button.style.color = btnTextColor;
                button.style.borderRadius = '4px';
                button.style.padding = '8px 16px';
                button.style.transition = 'all 0.3s ease';
                
                // Efecto hover
                button.onmouseover = () => {
                  button.style.opacity = '0.9';
                  button.style.transform = 'translateY(-1px)';
                  button.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
                };
                button.onmouseout = () => {
                  button.style.opacity = '1';
                  button.style.transform = 'translateY(0)';
                  button.style.boxShadow = 'none';
                };
              }
            });
            
            // Mejorar las im√°genes dentro de las tarjetas
            const images = card.querySelectorAll('img');
            images.forEach(img => {
              if (!img.closest('button')) {
                img.style.borderRadius = '4px';
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                img.style.display = 'block';
                img.style.margin = '0 auto 10px';
              }
            });
          });
        }
        
        // Aplicar color de botones
        if (colors.btnColor) {
          // Actualizar variables CSS
          document.documentElement.style.setProperty('--primary', colors.btnColor);
          
          // Calcular variantes de color
          const darkerColor = shadeColor(colors.btnColor, -15);
          const lighterColor = shadeColor(colors.btnColor, 15);
          
          // Aplicar a botones
          const buttons = document.querySelectorAll('button, .wsp, .btn, .cat');
          buttons.forEach(button => {
            if (button.classList.contains('cat')) {
              // Estilo especial para las pesta√±as de categor√≠as
              if (button.classList.contains('active')) {
                button.style.backgroundColor = colors.btnColor;
                button.style.color = getContrastColor(colors.btnColor);
              } else {
                button.style.backgroundColor = 'transparent';
                button.style.color = colors.btnColor;
              }
              button.style.borderColor = colors.btnColor;
            } else {
              // Estilo para botones normales
              button.style.backgroundColor = colors.btnColor;
              button.style.borderColor = darkerColor;
              button.style.color = getContrastColor(colors.btnColor);
              
              // Efecto hover
              button.onmouseover = () => {
                button.style.backgroundColor = darkerColor;
              };
              button.onmouseout = () => {
                button.style.backgroundColor = colors.btnColor;
              };
            }
          });
          
          // Aplicar a enlaces
          const links = document.querySelectorAll('a:not(.nav-item)');
          links.forEach(link => {
            link.style.color = colors.btnColor;
            link.onmouseover = () => {
              link.style.opacity = '0.8';
            };
            link.onmouseout = () => {
              link.style.opacity = '1';
            };
          });
          
          // Aplicar a elementos con clase .wsp
          const wspElements = document.querySelectorAll('.wsp');
          wspElements.forEach(el => {
            el.style.backgroundColor = colors.btnColor;
            el.style.color = getContrastColor(colors.btnColor);
          });
        }
        
        console.log('Colores aplicados correctamente');
      } catch (error) {
        console.error('Error al aplicar los colores:', error);
      }
    }
    
    // Funci√≥n mejorada para obtener un color de texto con buen contraste
    function getContrastColor(hexColor) {
      // Si no hay color o es inv√°lido, devolver negro por defecto
      if (!hexColor || typeof hexColor !== 'string') return '#333333';
      
      try {
        // Limpiar y formatear el color
        let color = hexColor.trim();
        
        // Si no empieza con #, agregarlo
        if (!color.startsWith('#')) color = '#' + color;
        
        // Manejar formatos cortos (#RGB)
        if (color.length === 4) {
          color = '#' + color[1] + color[1] + color[2] + color[2] + color[3] + color[3];
        }
        
        // Validar formato
        if (!/^#[0-9A-F]{6}$/i.test(color)) return '#333333';
        
        // Convertir a RGB
        const r = parseInt(color.substr(1, 2), 16);
        const g = parseInt(color.substr(3, 2), 16);
        const b = parseInt(color.substr(5, 2), 16);
        
        // Calcular brillo (f√≥rmula de luminosidad percibida mejorada)
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        
        // Usar un umbral m√°s alto (180) para mejor legibilidad
        // y asegurar que el contraste sea suficiente
        return brightness > 180 ? '#333333' : '#ffffff';
      } catch (e) {
        console.error('Error al calcular el contraste:', e);
        return '#333333'; // En caso de error, devolver negro
      }
    }

    // Funci√≥n para oscurecer/aclarar colores
    function shadeColor(color, percent) {
      let R = parseInt(color.substring(1,3), 16);
      let G = parseInt(color.substring(3,5), 16);
      let B = parseInt(color.substring(5,7), 16);

      R = parseInt(R * (100 + percent) / 100);
      G = parseInt(G * (100 + percent) / 100);
      B = parseInt(B * (100 + percent) / 100);

      R = (R<255)?R:255;  
      G = (G<255)?G:255;  
      B = (B<255)?B:255;  

      R = Math.round(R);
      G = Math.round(G);  
      B = Math.round(B);

      const RR = ((R.toString(16).length===1) ? "0"+R.toString(16):R.toString(16));
      const GG = ((G.toString(16).length===1) ? "0"+G.toString(16):G.toString(16));
      const BB = ((B.toString(16).length===1) ? "0"+B.toString(16):B.toString(16));

      return "#"+RR+GG+BB;
    }
    const productsDiv = document.getElementById("products");

    // Cargar imagen de encabezado directamente desde Firestore
    async function loadHeaderImage() {
      try {
        const settingsDoc = await getDoc(doc(db, "settings", "main"));
        if (settingsDoc.exists() && settingsDoc.data().header) {
          headerImg.src = settingsDoc.data().header;
          headerImg.style.display = 'block';
        } else {
          headerImg.style.display = 'none';
        }
      } catch (error) {
        console.error("Error cargando la imagen de encabezado:", error);
        headerImg.style.display = 'none';
      }
    }
    
    // Variables globales
    let allProducts = [];
    let currentCategory = 'all';
    let whatsappNumber = '';
    
    // Funci√≥n para cargar colores
    async function loadColors() {
      console.log('Cargando colores...');
      try {
        // Primero intentar cargar desde localStorage (m√°s r√°pido)
        const savedColors = JSON.parse(localStorage.getItem('adminColors') || '{}');
        
        if (savedColors.bgColor || savedColors.btnColor) {
          console.log('Colores cargados desde localStorage:', savedColors);
          applyColors(savedColors);
        }
        
        // Luego cargar desde Firestore y actualizar si es necesario
        try {
          const colorsDoc = await getDoc(doc(db, 'settings', 'colors'));
          if (colorsDoc.exists()) {
            const colors = colorsDoc.data();
            console.log('Colores cargados desde Firestore:', colors);
            
            // Actualizar localStorage con los valores de Firestore
            localStorage.setItem('adminColors', JSON.stringify(colors));
            
            // Aplicar los colores
            applyColors(colors);
          }
        } catch (error) {
          console.error('Error cargando colores de Firestore:', error);
        }
      } catch (error) {
        console.error('Error cargando colores:', error);
      }
    }
    
    // Inicializar la aplicaci√≥n
    async function init() {
      try {
        // Cargar configuraci√≥n y colores
        await Promise.all([
          loadSettings(),
          loadColors()
        ]);
        // Cargar imagen de encabezado
        await loadHeaderImage();
        
        // Cargar categor√≠as y productos en paralelo
        await Promise.all([
          loadCategories(),
          loadProducts()
        ]);
        
      } catch (error) {
        console.error('Error al inicializar:', error);
        showError('Error al cargar los datos. Por favor, recarga la p√°gina.');
      }
    }
    
    // Cargar configuraci√≥n
    async function loadSettings() {
      try {
        const settingsDoc = await getDoc(doc(db, "settings", "main"));
        if (settingsDoc.exists()) {
          const settings = settingsDoc.data();
          
          // Establecer imagen de encabezado
          if (settings.header) {
            headerImg.src = settings.header;
          }
          
          // Guardar n√∫mero de WhatsApp
          if (settings.whatsapp) {
            whatsappNumber = settings.whatsapp;
          }
        }
      } catch (error) {
        console.error('Error cargando configuraci√≥n:', error);
        throw error;
      }
    }
    
    // Guardar categor√≠as en cach√©
    function saveCategoriesToCache(categories) {
      localStorage.setItem('storeCategories', JSON.stringify({
        categories: categories,
        lastUpdated: Date.now()
      }));
    }
    
    // Cargar categor√≠as desde cach√©
    function loadCategoriesFromCache() {
      const cached = localStorage.getItem('storeCategories');
      if (cached) {
        try {
          const data = JSON.parse(cached);
          if (data && data.categories && Array.isArray(data.categories)) {
            return data.categories;
          }
        } catch (e) {
          console.error("Error al cargar categor√≠as desde cach√©:", e);
        }
      }
      return null;
    }
    
    // Renderizar categor√≠as
    function renderCategories(categories) {
      // Ordenar categor√≠as alfab√©ticamente
      categories.sort((a, b) => a.name.localeCompare(b.name));
      
      // Limpiar categor√≠as existentes
      catsDiv.innerHTML = '';
      
      // A√±adir bot√≥n "Todos"
      const allButton = document.createElement('button');
      allButton.className = 'cat' + (currentCategory === 'all' ? ' active' : '');
      allButton.textContent = 'Todos';
      allButton.onclick = () => filterProducts('all');
      catsDiv.appendChild(allButton);
      
      // A√±adir cada categor√≠a
      categories.forEach(category => {
        const button = document.createElement('button');
        button.className = 'cat' + (currentCategory === category.name ? ' active' : '');
        button.textContent = category.name;
        button.onclick = () => filterProducts(category.name);
        catsDiv.appendChild(button);
      });
    }
    
    // Cargar categor√≠as
    async function loadCategories() {
      try {
        // Cargar desde cach√© primero
        const cachedCategories = loadCategoriesFromCache();
        if (cachedCategories && cachedCategories.length > 0) {
          renderCategories(cachedCategories);
        }
        
        // Actualizar desde Firestore en segundo plano
        try {
          const querySnapshot = await getDocs(collection(db, "categories"));
          const categories = [];
          
          querySnapshot.forEach((doc) => {
            categories.push({ id: doc.id, ...doc.data() });
          });
          
          // Guardar en cach√©
          saveCategoriesToCache(categories);
          
          // Solo volver a renderizar si hay cambios
          if (!cachedCategories || 
              JSON.stringify(categories) !== JSON.stringify(cachedCategories)) {
            renderCategories(categories);
          }
        } catch (firestoreError) {
          console.error("Error al cargar categor√≠as desde Firestore:", firestoreError);
          // Si no hay categor√≠as en cach√© y falla Firestore, mostrar error
          if (!cachedCategories || cachedCategories.length === 0) {
            catsDiv.innerHTML = '<div class="error">Error al cargar las categor√≠as. Intenta recargar la p√°gina.</div>';
          }
        }
      } catch (error) {
        console.error('Error cargando categor√≠as:', error);
        throw error;
      }
    }
    
    // Cargar productos
    async function loadProducts() {
      try {
        productsDiv.innerHTML = '<div class="loading">Cargando productos...</div>';
        
        const productsSnapshot = await getDocs(collection(db, "products"));
        allProducts = [];
        
        productsSnapshot.forEach((doc) => {
          allProducts.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        // Ordenar productos por fecha de creaci√≥n (m√°s recientes primero)
        allProducts.sort((a, b) => {
          const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
          const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
          return dateB - dateA;
        });
        
        // Mostrar productos
        if (allProducts.length === 0) {
          showNoProducts();
        } else {
          renderProducts(allProducts);
        }
        
      } catch (error) {
        console.error('Error cargando productos:', error);
        showError('Error al cargar los productos. Por favor, int√©ntalo de nuevo.');
      }
    }
    
    // Filtrar productos por categor√≠a
    function filterProducts(category) {
      currentCategory = category;
      
      // Actualizar clases activas en los botones de categor√≠a
      const categoryButtons = document.querySelectorAll('.cat');
      categoryButtons.forEach(btn => {
        if ((category === 'all' && btn.textContent === 'Todos') || 
            btn.textContent === category) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
      
      // Filtrar productos
      const filteredProducts = category === 'all' 
        ? allProducts 
        : allProducts.filter(p => p.category === category);
      
      // Mostrar productos filtrados
      if (filteredProducts.length === 0) {
        showNoProducts();
      } else {
        renderProducts(filteredProducts);
      }
    }
    
    // Renderizar lista de productos
    function renderProducts(products) {
      productsDiv.innerHTML = '';
      
      // Obtener colores guardados
      const savedColors = JSON.parse(localStorage.getItem('adminColors') || '{}');
      const bgColor = savedColors.bgColor || '#ffffff';
      const btnColor = savedColors.btnColor || '#25d366';
      
      // Calcular colores derivados
      const adjustedBgColor = adjustColor ? adjustColor(bgColor) : bgColor;
      const textColor = getContrastColor ? (getContrastColor(adjustedBgColor) === '#ffffff' ? '#333333' : '#ffffff') : '#333333';
      
      products.forEach(product => {
        const productElement = document.createElement('div');
        productElement.className = 'card';
        
        // Aplicar estilos directamente al elemento
        productElement.style.backgroundColor = adjustedBgColor;
        productElement.style.color = textColor;
        productElement.style.borderRadius = '8px';
        productElement.style.padding = '15px';
        productElement.style.marginBottom = '20px';
        productElement.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
        productElement.style.transition = 'all 0.3s ease';
        
        // Construir la URL de WhatsApp con mensaje predefinido
        let whatsappUrl = '#';
        if (whatsappNumber) {
          const message = encodeURIComponent(`Hola, quiero comprar ${product.title || 'Producto'} de $${product.price || '0'}`);
          whatsappUrl = `https://wa.me/${whatsappNumber}?text=${message}`;
        }
        
        productElement.innerHTML = `
          <div class="product-image" style="overflow: hidden; border-radius: 4px; margin-bottom: 12px;">
            <img src="${product.image || 'https://via.placeholder.com/300x200?text=Sin+imagen'}" 
                 alt="${product.title || 'Producto'}"
                 onerror="this.src='https://via.placeholder.com/300x200?text=Error+al+cargar'"
                 style="width: 100%; height: auto; display: block; transition: transform 0.3s ease;">
          </div>
          <div class="info" style="padding: 8px 0;">
            <h3 style="margin: 0 0 8px 0; font-size: 1.1em; color: ${getContrastColor(adjustedBgColor) === '#333333' ? '#000000' : '#ffffff'};">${product.title || 'Sin t√≠tulo'}</h3>
            <div class="price" style="color: ${btnColor}; font-weight: bold; font-size: 1.2em; margin-bottom: 12px;">
              $${product.price ? product.price.toLocaleString() : '0'}
            </div>
            ${whatsappNumber ? `
              <a href="${whatsappUrl}" 
                 class="wsp" 
                 target="_blank" 
                 rel="noopener noreferrer"
                 style="display: inline-flex; align-items: center; justify-content: center;
                        background-color: ${btnColor}; 
                        color: ${getContrastColor ? getContrastColor(btnColor) : '#ffffff'};
                        text-decoration: none; 
                        padding: 8px 16px; 
                        border-radius: 4px; 
                        font-weight: 500;
                        transition: all 0.3s ease;">
                <span style="margin-right: 6px;">üí¨</span> Consultar
              </a>` : ''
            }
          </div>
        `;
        
        // A√±adir efecto hover a la imagen
        const img = productElement.querySelector('img');
        if (img) {
          productElement.onmouseover = () => {
            productElement.style.transform = 'translateY(-2px)';
            productElement.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)';
            if (img) img.style.transform = 'scale(1.05)';
          };
          productElement.onmouseout = () => {
            productElement.style.transform = 'translateY(0)';
            productElement.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
            if (img) img.style.transform = 'scale(1)';
          };
        }
        
        productsDiv.appendChild(productElement);
      });
    }
    
    // Mostrar mensaje cuando no hay productos
    function showNoProducts() {
      productsDiv.innerHTML = `
        <div class="no-products">
          <p>No hay productos ${currentCategory === 'all' ? '' : 'en esta categor√≠a '}disponibles.</p>
          ${currentCategory !== 'all' ? '<button onclick="filterProducts(\'all\')" class="wsp" style="margin: 10px auto 0; display: inline-block; padding: 8px 16px;">Ver todos los productos</button>' : ''}
        </div>
      `;
    }
    
    // Mostrar mensaje de error
    function showError(message) {
      productsDiv.innerHTML = `
        <div class="no-products" style="color: #d32f2f;">
          <p>${message}</p>
          <button onclick="window.location.reload()" class="wsp" style="background: #d32f2f; margin-top: 10px;">
            Recargar p√°gina
          </button>
        </div>
      `;
    }
    
    // Hacer la funci√≥n de filtro accesible globalmente
    window.filterProducts = filterProducts;
    
    // Inicializar la aplicaci√≥n cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', init);
  </script>

</body>
</html>
