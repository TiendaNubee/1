<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Productos</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root {
    --primary: #25d366;
    --primary-dark: #128C7E;
    --secondary: #f5f5f5;
    --text: #333;
    --text-light: #666;
    --white: #fff;
    --shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    background: var(--secondary);
    color: var(--text);
    line-height: 1.5;
    padding: 15px;
    padding-bottom: 70px;
  }

  /* Estilos de la barra de navegaci√≥n */
.nav-bar {
  display: flex;
  justify-content: space-around;
  background: var(--white);
  padding: 10px 0;
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  box-shadow: var(--shadow);
  z-index: 1000;
}

.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-decoration: none;
  color: var(--text-light);
  font-size: 12px;
  padding: 5px 10px;
  border-radius: 8px;
  transition: all 0.3s;
}

.nav-item:hover {
  background: var(--secondary);
  color: var(--primary);
}

.nav-item.active {
  color: var(--primary);
}

.nav-icon {
  font-size: 24px;
  margin-bottom: 4px;
}


/* Estilos para la cuadr√≠cula de productos */
.products-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  padding: 10px 0;
  width: 100%;
  max-width: 100%;
  margin: 0 auto;
  box-sizing: border-box;
}

.product-card {
  background: var(--white);
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
  display: flex;
  flex-direction: column;
  height: 100%;
  border: 1px solid rgba(0,0,0,0.05);
  position: relative;
}

.product-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.product-image {
  width: 100%;
  height: 0;
  padding-bottom: 75%; /* Proporci√≥n 4:3 */
  position: relative;
  overflow: hidden;
}

.product-image img {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s;
}

.product-card:hover .product-image img {
  transform: scale(1.05);
}

.product-info {
  padding: 10px;
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.product-title {
  font-weight: 600;
  margin: 0;
  font-size: 14px;
  color: var(--text);
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  min-height: 36px;
  line-height: 1.2;
}

.product-price {
  color: #25d366;
  font-weight: 700;
  font-size: 16px;
  margin: 2px 0 0 0;
  line-height: 1.2;
}

.product-category {
  color: var(--text-light);
  font-size: 12px;
  margin: 3px 0;
}

.product-actions {
  display: flex;
  justify-content: space-between;
  margin-top: 10px;
  gap: 8px;
}

.btn-edit, .btn-delete {
  border: none;
  border-radius: 6px;
  padding: 6px 0;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  transition: all 0.2s;
  flex: 1;
}

.btn-edit {
  background-color: var(--primary);
  color: white;
}

.btn-edit:hover {
  background-color: var(--primary-dark);
}

.btn-delete {
  background-color: #ff4444;
  color: white;
}

.btn-delete:hover {
  background-color: #e53935;
}

/* Modal styles */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}

.modal-content {
  background: white;
  padding: 20px;
  border-radius: 8px;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.modal-content input,
.modal-content select {
  width: 100%;
  padding: 8px;
  margin: 8px 0;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.modal-content button {
  background: #4CAF50;
  color: white;
  border: none;
  padding: 10px 15px;
  border-radius: 4px;
  cursor: pointer;
  margin-top: 10px;
}

.modal-content button:hover {
  background: #45a049;
}
</style>
</head>

<body>

<div style="max-width: 500px; margin: 20px auto; display: flex; flex-direction: column; gap: 12px;">
  <button 
    onclick="openModal()" 
    style="
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 2px 10px rgba(37, 211, 102, 0.3);
      transition: all 0.3s ease;
      width: 100%;
      box-sizing: border-box;
    "
    onmouseover="this.style.background='#20bd5a'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(37, 211, 102, 0.4)';"
    onmouseout="this.style.background='#25d366'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 10px rgba(37, 211, 102, 0.3)';"
  >
    <span style="font-size: 18px; line-height: 1;">+</span> Nuevo Producto
  </button>
  
  <div style="width: 100%; position: relative;">
    <input 
      type="text" 
      id="searchInput" 
      placeholder="üîç Buscar productos..." 
      style="
        width: 100%;
        padding: 12px 15px 12px 40px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        outline: none;
        transition: all 0.3s;
        box-sizing: border-box;
        height: 44px;
      "
      onfocus="this.style.borderColor='#25d366'; this.style.boxShadow='0 0 0 2px rgba(37, 211, 102, 0.2)';"
      onblur="this.style.borderColor='#ddd'; this.style.boxShadow='none';"
    >
  </div>
</div>

<div id="list" style="margin-top: 15px;"></div>

<!-- Modal de edici√≥n -->
<div id="productModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;">
  <div class="modal-content" style="background: white; padding: 20px; border-radius: 12px; width: 100%; max-width: 420px; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.15); position: relative;">
    <h2 id="modalTitle" style="margin: 0 0 20px 0; color: var(--text); font-size: 20px; text-align: center; padding-bottom: 12px; border-bottom: 1px solid rgba(0,0,0,0.1); display: none;"></h2>
    
    <!-- Input de imagen oculto -->
    <input type="file" id="productImage" accept="image/*" style="display: none;">
    <input type="hidden" id="imageUrl" name="imageUrl" value="">
    
    <!-- Contenedor de vista previa de imagen -->
    <div id="imageContainer" style="position: relative; margin-bottom: 20px;">
      <div id="imagePreview" style="width: 100%; height: 200px; border: 2px dashed #ddd; border-radius: 10px; display: flex; justify-content: center; align-items: center; background-color: #f9f9f9; background-size: cover; background-position: center; cursor: pointer; transition: all 0.3s ease;" 
           onclick="document.getElementById('productImage').click()">
        <div id="imagePlaceholder" style="text-align: center; color: #999; padding: 20px;">
          <div style="font-size: 40px; margin-bottom: 10px;">üì∑</div>
          <div style="font-size: 14px; font-weight: 500;">Toca para agregar una foto</div>
          <div style="font-size: 12px; margin-top: 5px;">Recomendado: 800x600px</div>
        </div>
      </div>
      <button id="removeImageBtn" onclick="removeImage()" style="display: none; position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s;">
        ‚úï
      </button>
    </div>
    
    <!-- Campos del formulario -->
    <div style="margin-bottom: 16px;">
      <label for="productName" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text);">T√≠tulo del producto</label>
      <input type="text" id="productName" placeholder="Ej: Camiseta de algod√≥n" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; transition: border-color 0.3s;" onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='#ddd'">
    </div>
    
    <div style="display: flex; gap: 15px; margin-bottom: 16px;">
      <div style="flex: 1;">
        <label for="productPrice" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text);">Precio</label>
        <div style="position: relative;">
          <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #666; font-weight: 500;">$</span>
          <input type="number" id="productPrice" placeholder="0.00" min="0" step="0.01" style="width: 100%; padding: 12px 12px 12px 30px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px;" onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='#ddd'">
        </div>
      </div>
      
      <div style="flex: 1;">
        <label for="productCategory" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text);">Categor√≠a</label>
      <select 
  id="productCategory" 
  style="width: 100%; padding: 11px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; background-color: white; cursor: pointer; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 10px center; background-size: 12px;" 
  onfocus="this.style.borderColor='var(--primary)'" 
  onblur="this.style.borderColor='#ddd'">
  <!-- Las opciones se cargar√°n din√°micamente -->
</select>
      </div>
    </div>
    
    <!-- Botones de acci√≥n -->
    <div style="display: flex; gap: 12px; margin-top: 24px;">
      <button onclick="document.getElementById('productModal').style.display = 'none'" style="flex: 1; padding: 14px; background-color: #f5f5f5; color: #333; border: none; border-radius: 8px; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
        Cancelar
      </button>
      <button id="saveBtn" onclick="save()" style="flex: 1; padding: 14px; background-color: var(--primary); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
        Guardar
      </button>
    </div>
  </div>
</div>

<script type="module" src="app.js"></script>
  <script>
  
  // La funci√≥n removeImage est√° definida m√°s abajo
  
  // Manejar la carga de im√°genes
  document.getElementById('productImage').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(event) {
        const imagePreview = document.getElementById('imagePreview');
        const removeImageBtn = document.getElementById('removeImageBtn');
        
        imagePreview.style.backgroundImage = `url(${event.target.result})`;
        imagePreview.innerHTML = '';
        removeImageBtn.style.display = 'flex';
      };
      reader.readAsDataURL(file);
    }
  });
    // Funci√≥n para obtener el color de texto con mejor contraste
  function getContrastColor(hexColor) {
    // Convertir color hexadecimal a RGB
    const r = parseInt(hexColor.slice(1, 3), 16);
    const g = parseInt(hexColor.slice(3, 5), 16);
    const b = parseInt(hexColor.slice(5, 7), 16);
    
    // Calcular brillo (f√≥rmula de luminosidad)
    const brightness = (r * 299 + g * 587 + b * 114) / 1000;
    
    // Devolver blanco o negro seg√∫n el brillo del fondo
    return brightness > 128 ? '#000000' : '#ffffff';
  }

  // Funci√≥n para oscurecer un color
  function shadeColor(color, percent) {
    let R = parseInt(color.substring(1,3), 16);
    let G = parseInt(color.substring(3,5), 16);
    let B = parseInt(color.substring(5,7), 16);

    R = parseInt(R * (100 + percent) / 100);
    G = parseInt(G * (100 + percent) / 100);
    B = parseInt(B * (100 + percent) / 100);

    R = (R<255)?R:255;  
    G = (G<255)?G:255;  
    B = (B<255)?B:255;  

    R = Math.round(R);
    G = Math.round(G);  
    B = Math.round(B);

    const RR = ((R.toString(16).length===1) ? "0"+R.toString(16):R.toString(16));
    const GG = ((G.toString(16).length===1) ? "0"+G.toString(16):G.toString(16));
    const BB = ((B.toString(16).length===1) ? "0"+B.toString(16):B.toString(16));

    return "#"+RR+GG+BB;
  }

  // Funci√≥n para aplicar los colores guardados
  function applyColors(colors) {
    console.log('Aplicando colores:', colors);
    
    try {
      // Aplicar color de fondo
      if (colors.bgColor) {
        // Aplicar al body
        document.body.style.backgroundColor = colors.bgColor;
        document.documentElement.style.setProperty('--secondary', colors.bgColor);
        
        // Determinar si el fondo es oscuro para ajustar colores de texto
        const isDark = getContrastColor(colors.bgColor) === '#ffffff';
        const isVeryLight = colors.bgColor && 
                          (colors.bgColor.toLowerCase() === '#ffffff' || 
                           colors.bgColor.toLowerCase() === '#f5f5f5' ||
                           (colors.bgColor.startsWith('rgb') && colors.bgColor.includes('255, 255, 255')));
        
        const textColor = isDark ? '#ffffff' : (isVeryLight ? '#000000' : '#333333');
        const textLightColor = isDark ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)';
        
        // Aplicar colores de texto
        document.body.style.color = textColor;
        document.documentElement.style.setProperty('--text', textColor);
        document.documentElement.style.setProperty('--text-light', textLightColor);
        
        // Aplicar a las tarjetas de productos
        const cardBgColor = isDark ? 'rgba(40, 40, 40, 0.8)' : 'rgba(255, 255, 255, 0.95)';
        const cardTextColor = isDark ? '#ffffff' : '#333333';
        
        document.querySelectorAll('.product-card').forEach(card => {
          card.style.backgroundColor = cardBgColor;
          card.style.color = cardTextColor;
          
          // Asegurar que el texto dentro de la tarjeta tenga el color correcto
          const title = card.querySelector('.product-title');
          const price = card.querySelector('.product-price');
          const category = card.querySelector('.product-category');
          
          if (title) {
            title.style.color = isVeryLight ? '#000000' : cardTextColor;
            title.style.fontWeight = isVeryLight ? '600' : '500';
          }
          if (price) price.style.color = colors.btnColor || '#25d366';
          if (category) {
            category.style.color = isVeryLight ? 'rgba(0, 0, 0, 0.8)' : textLightColor;
            category.style.backgroundColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 
                                   (isVeryLight ? 'rgba(0, 0, 0, 0.08)' : 'rgba(0, 0, 0, 0.05)');
            category.style.fontWeight = isVeryLight ? '500' : 'normal';
          }
        });
      }
        
        // Aplicar color primario
        if (colors.btnColor) {
          document.documentElement.style.setProperty('--primary', colors.btnColor);
          
          // Calcular un color m√°s oscuro para el hover
          const darkerColor = getDarkerColor(colors.btnColor, 15);
          document.documentElement.style.setProperty('--primary-dark', darkerColor);
          
          // Aplicar a los botones
          const buttons = document.querySelectorAll('button, .btn-edit');
          buttons.forEach(btn => {
            if (!btn.classList.contains('btn-delete')) {
              btn.style.backgroundColor = colors.btnColor;
              btn.style.borderColor = colors.btnColor;
            }
          });
        }
        
        // Aplicar color de texto
        if (colors.textColor) {
          document.documentElement.style.setProperty('--text', colors.textColor);
          
          // Calcular un color de texto m√°s claro
          const lighterText = getLighterColor(colors.textColor, 40);
          document.documentElement.style.setProperty('--text-light', lighterText);
        }
      } catch (error) {
        console.error('Error al aplicar los colores:', error);
      }
    }
    
    // Funci√≥n para oscurecer un color
    function getDarkerColor(color, percent) {
      const num = parseInt(color.replace('#', ''), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) - amt;
      const G = (num >> 8 & 0x00FF) - amt;
      const B = (num & 0x0000FF) - amt;
      return '#' + (0x1000000 + (R < 0 ? 0 : R) * 0x10000 + 
                    (G < 0 ? 0 : G) * 0x100 + 
                    (B < 0 ? 0 : B)).toString(16).slice(1);
    }
    
    // Funci√≥n para aclarar un color
    function getLighterColor(color, percent) {
      const num = parseInt(color.replace('#', ''), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) + amt;
      const G = (num >> 8 & 0x00FF) + amt;
      const B = (num & 0x0000FF) + amt;
      return '#' + (0x1000000 + (R < 255 ? R : 255) * 0x10000 + 
                    (G < 255 ? G : 255) * 0x100 + 
                    (B < 255 ? B : 255)).toString(16).slice(1);
    }
    
    // Funci√≥n para cargar y aplicar los colores
    function loadAndApplyColors() {
      // Obtener colores guardados
      const savedColors = JSON.parse(localStorage.getItem('adminColors') || '{}');
      
      if (Object.keys(savedColors).length > 0) {
        applyColors(savedColors);
      } else {
        // Si no hay colores guardados, aplicar valores por defecto
        const defaultColors = {
          bgColor: '#f5f5f5',
          btnColor: '#25d366',
          textColor: '#333333'
        };
        applyColors(defaultColors);
      }
      
      // Volver a aplicar los colores despu√©s de cargar los productos
      setTimeout(() => {
        const currentColors = JSON.parse(localStorage.getItem('adminColors') || '{}');
        if (currentColors) {
          applyColors(currentColors);
        }
      }, 500);
    }
  
  // Cargar colores al iniciar la p√°gina
  document.addEventListener('DOMContentLoaded', () => {
    loadAndApplyColors();
    
    // Escuchar cambios en los colores
    window.addEventListener('storage', (e) => {
      if (e.key === 'adminColors') {
        const newColors = JSON.parse(e.newValue || '{}');
        applyColors(newColors);
      }
    });
  });
  </script>
<script>
// Esperar a que el DOM est√© completamente cargado
document.addEventListener('DOMContentLoaded', async () => {
  // Inicializar referencias a los elementos del DOM
  const list = document.getElementById("list");
  const cat = document.getElementById("cat");
  
// Funci√≥n global para abrir el modal de producto
window.openModal = async function(product = null) {
    const modal = document.getElementById('productModal');
    const imagePreview = document.getElementById('imagePreview');
    const removeImageBtn = document.getElementById('removeImageBtn');
    const productImage = document.getElementById('productImage');
    const productName = document.getElementById('productName');
    const productPrice = document.getElementById('productPrice');
    const productCategory = document.getElementById('productCategory');
    const modalTitle = document.getElementById('modalTitle');
    const saveBtn = document.getElementById('saveBtn');
    
    // Resetear el formulario
    productName.value = '';
    productPrice.value = '';
    productImage.value = '';
    
    // Mostrar placeholder de imagen
    imagePreview.innerHTML = `
      <div id="imagePlaceholder" style="text-align: center; color: #999; padding: 20px;">
        <div style="font-size: 40px; margin-bottom: 10px;">üì∑</div>
        <div style="font-size: 14px; font-weight: 500;">Toca para agregar una foto</div>
        <div style="font-size: 12px; margin-top: 5px;">Recomendado: 800x600px</div>
      </div>
    `;
    
    removeImageBtn.style.display = 'none';
    
    // Si se est√° editando un producto, cargar sus datos
    if (product) {
      modalTitle.textContent = 'Editar Producto';
      saveBtn.textContent = 'Actualizar';
      productName.value = product.title || product.name || '';
      productPrice.value = product.price || '';
      
      // Establecer la categor√≠a si existe
      if (product.category) {
        productCategory.value = product.category;
      }
      
      // Mostrar imagen si existe
      if (product.image) {
        imagePreview.style.backgroundImage = `url('${product.image}')`;
        imagePreview.querySelector('#imagePlaceholder').style.display = 'none';
        removeImageBtn.style.display = 'flex';
      }
      
      // Configurar el bot√≥n de guardar para modo edici√≥n
      saveBtn.onclick = () => save(product.id);
    } else {
      modalTitle.textContent = 'Nuevo Producto';
      saveBtn.textContent = 'Guardar';
      saveBtn.onclick = save;
    }
    
    // Mostrar el modal
    modal.style.display = 'flex';
    
    // Enfocar el primer campo
    setTimeout(() => {
      productName.focus();
    }, 100);
  }

  // Funci√≥n para cargar las categor√≠as
  async function loadCategories() {
    try {
      const cat = document.getElementById('productCategory');
      if (!cat) {
        console.error('Elemento con ID "productCategory" no encontrado');
        return;
      }
      
      const categoriesSnapshot = await window.getDocs(window.collection(window.db, "categories"));
      categoriesSnapshot.forEach(doc => {
        const option = document.createElement('option');
        option.value = doc.data().name;
        option.textContent = doc.data().name;
        cat.appendChild(option);
      });
    } catch (error) {
      console.error("Error al cargar categor√≠as:", error);
    }
  }
  
  // Cargar categor√≠as al inicio
  (async () => {
    await loadCategories();
  })();
  
  // Variable para almacenar los productos en memoria
  let products = [];

async function load() {
  try {
    list.innerHTML = '<div style="text-align: center; padding: 20px;">Cargando productos...</div>';
    
    // Limpiar la lista actual
    products = [];
    
    // Obtener productos de Firestore
    const prodsSnapshot = await window.getDocs(window.collection(db, "products"));
    
    // Mapear los productos a un array
    products = prodsSnapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    
    // Mostrar productos
    displayProducts(products);
  } catch (error) {
    console.error("Error al cargar productos:", error);
    list.innerHTML = `
      <div style="text-align: center; color: #f44336; padding: 20px;">
        Error al cargar los productos. Por favor, recarga la p√°gina.
      </div>`;
  }
}

// Funci√≥n para mostrar productos
function displayProducts(productsToShow) {
  if (!productsToShow || productsToShow.length === 0) {
    list.innerHTML = `
      <div style="text-align: center; padding: 20px; color: var(--text-light); grid-column: 1 / -1;">
        No hay productos para mostrar.
      </div>`;
    // Aplicar colores nuevamente despu√©s de actualizar el contenido
    const currentColors = JSON.parse(localStorage.getItem('adminColors') || '{}');
    if (currentColors) applyColors(currentColors);
    return;
  }
  
  list.innerHTML = '<div class="products-grid"></div>';
  const grid = list.querySelector('.products-grid');
  
  // Obtener colores guardados
  const savedColors = JSON.parse(localStorage.getItem('adminColors') || '{}');
  const bgColor = savedColors.bgColor || '#f5f5f5';
  const cardBgColor = bgColor === '#ffffff' ? '#ffffff' : 'rgba(255, 255, 255, 0.95)';
  
  // Usar un Set para evitar IDs duplicados
  const productIds = new Set();
  
  productsToShow.forEach(product => {
    if (!productIds.has(product.id)) {
      productIds.add(product.id);
      
      const productCard = document.createElement('div');
      productCard.className = 'product-card';
      productCard.dataset.id = product.id;
      productCard.style.backgroundColor = cardBgColor;
      productCard.style.border = '1px solid rgba(0,0,0,0.05)';
      productCard.style.borderRadius = '8px';
      productCard.style.overflow = 'hidden';
      productCard.style.transition = 'all 0.3s ease';
      productCard.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
      
      productCard.onmouseover = () => {
        productCard.style.transform = 'translateY(-3px)';
        productCard.style.boxShadow = '0 4px 15px rgba(0,0,0,0.15)';
      };
      
      productCard.onmouseout = () => {
        productCard.style.transform = 'translateY(0)';
        productCard.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
      };
      
      productCard.innerHTML = `
        <div class="product-image" style="overflow: hidden; border-radius: 8px; margin-bottom: 12px; background: #f8f8f8;">
          <img 
            src="${product.image || 'data:image/svg+xml;utf8,<svg width="300" height="200" viewBox="0 0 300 200" xmlns="http://www.w3.org/2000/svg"><rect width="100%" height="100%" fill="%23f5f5f5"/><text x="50%" y="50%" font-family="sans-serif" font-size="14" text-anchor="middle" dominant-baseline="middle" fill="%23999">Sin imagen</text></svg>'}" 
            alt="${product.title || 'Producto'}"
            onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<svg width=\'300\' height=\'200\' viewBox=\'0 0 300 200\' xmlns=\'http://www.w3.org/2000/svg\'><rect width=\'100%\' height=\'100%\' fill=\'%23f5f5f5\'/><text x=\'50%\' y=\'50%\' font-family=\'sans-serif\' font-size=\'14\' text-anchor=\'middle\' dominant-baseline=\'middle\' fill=\'%23ff4444\'>Error al cargar</text></svg>'"
            style="width: 100%; height: auto; display: block; transition: transform 0.3s ease;"
            onmouseover="this.style.transform='scale(1.05)'"
            onmouseout="this.style.transform='scale(1)'">
        </div>
        <div class="product-info" style="
          padding: 12px;
          display: flex;
          flex-direction: column;
          flex-grow: 1;
        ">
          <h3 class="product-title" title="${product.title || ''}" style="
            margin: 0 0 4px 0;
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 40px;
            line-height: 1.3;
          ">
            ${product.title || 'Sin t√≠tulo'}
          </h3>
          <div class="product-price" style="
            color: var(--primary);
            font-weight: 700;
            font-size: 16px;
            margin: 4px 0;
          ">
            $${product.price || '0.00'}
          </div>
          ${product.category ? `
            <div class="product-category" style="
              color: var(--text-light);
              font-size: 12px;
              margin: 2px 0 8px 0;
              background: rgba(0,0,0,0.03);
              display: inline-block;
              padding: 2px 8px;
              border-radius: 4px;
              align-self: flex-start;
            ">
              ${product.category}
            </div>` : ''}
          
          <div class="product-actions" style="
            display: flex;
            gap: 8px;
            margin-top: auto;
          ">
            <button class="btn-edit" onclick="event.stopPropagation(); editProduct('${product.id}')" 
              style="flex:1;background:var(--primary);color:white;border:none;border-radius:4px;padding:8px 0;font-size:13px;font-weight:500;cursor:pointer;transition:all 0.2s"
              onmouseover="this.style.opacity='0.9'"
              onmouseout="this.style.opacity='1'">
              Editar
            </button>
            <button class="btn-delete" onclick="event.stopPropagation(); del('${product.id}')" 
              style="flex:1;background:#ff4444;color:white;border:none;border-radius:4px;padding:8px 0;font-size:13px;font-weight:500;cursor:pointer;transition:all 0.2s"
              onmouseover="this.style.opacity='0.9'"
              onmouseout="this.style.opacity='1'">
              Eliminar
            </button>
          </div>
        </div>
      `;
      
      grid.appendChild(productCard);
    }
  });
  
  // Aplicar estilos al grid - 2 columnas fijas
  grid.style.display = 'grid';
  grid.style.gridTemplateColumns = 'repeat(2, 1fr)';
  grid.style.gap = '10px';
  grid.style.padding = '10px 0';
  grid.style.maxWidth = '100%';
  grid.style.margin = '0 auto';
  
  // Aplicar colores nuevamente despu√©s de cargar los productos
  const currentColors = JSON.parse(localStorage.getItem('adminColors') || '{}');
  if (currentColors) applyColors(currentColors);
}

  // Cargar productos al iniciar la p√°gina
  load().then(() => {
    // Asegurarse de que los colores se apliquen despu√©s de cargar los productos
    const currentColors = JSON.parse(localStorage.getItem('adminColors') || '{}');
    if (currentColors) applyColors(currentColors);
  });

  // Funci√≥n para eliminar un producto
  window.del = async (id) => {
  if (confirm('¬øEst√°s seguro de que quieres eliminar este producto?')) {
    try {
      await window.deleteDoc(window.doc(db, "products", id));
      // Actualizar la lista de productos en memoria
      products = products.filter(p => p.id !== id);
      // Actualizar la vista
      displayProducts(products);
    } catch (error) {
      console.error("Error al eliminar el producto:", error);
      alert('Error al eliminar el producto. Por favor, int√©ntalo de nuevo.');
    }
  }
};

// Funci√≥n para editar un producto
window.editProduct = async (id) => {
  const product = products.find(p => p.id === id);
  if (!product) return;
  
  // Llenar el formulario con los datos del producto
  document.getElementById('productName').value = product.title || '';
  document.getElementById('productPrice').value = product.price || '';
  document.getElementById('productCategory').value = product.category || '';
  
  // Configurar la vista previa de la imagen si existe
  const imagePreview = document.getElementById('imagePreview');
  const imageUrlInput = document.getElementById('imageUrl');
  const removeImageBtn = document.getElementById('removeImageBtn');
  
  if (product.image) {
    // Mostrar la imagen existente
    imagePreview.innerHTML = ''; // Limpiar cualquier contenido previo
    imagePreview.style.backgroundImage = `url('${product.image}')`;
    imagePreview.style.backgroundSize = 'cover';
    imagePreview.style.backgroundPosition = 'center';
    imagePreview.style.backgroundRepeat = 'no-repeat';
    
    // Guardar la URL de la imagen en un campo oculto
    if (imageUrlInput) {
      imageUrlInput.value = product.image;
    }
    
    // Mostrar el bot√≥n de eliminar
    if (removeImageBtn) {
      removeImageBtn.style.display = 'flex';
    }
  } else {
    // Si no hay imagen, mostrar el placeholder
    imagePreview.innerHTML = `
      <div id="imagePlaceholder" style="text-align: center; color: #999; padding: 20px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <div style="font-size: 40px; margin-bottom: 10px;">üì∑</div>
        <div style="font-size: 14px; font-weight: 500;">Toca para agregar una foto</div>
        <div style="font-size: 12px; margin-top: 5px;">Recomendado: 800x600px</div>
      </div>
    `;
    
    // Ocultar el bot√≥n de eliminar
    if (removeImageBtn) {
      removeImageBtn.style.display = 'none';
    }
  }
  
  // Mostrar el modal de edici√≥n
  document.getElementById('productModal').style.display = 'flex';
  document.getElementById('modalTitle').textContent = 'Editar Producto';
  document.getElementById('saveBtn').textContent = 'Actualizar';
  
  // Guardar el ID del producto que se est√° editando
  document.getElementById('productModal').dataset.editingId = id;
};

// Funci√≥n para abrir el modal
async function openModal(product = null) {
  const modal = document.getElementById('productModal');
  const imagePreview = document.getElementById('imagePreview');
  const removeImageBtn = document.getElementById('removeImageBtn');
  const productImage = document.getElementById('productImage');
  const productName = document.getElementById('productName');
  const productPrice = document.getElementById('productPrice');
  const productCategory = document.getElementById('productCategory');
  const modalTitle = document.getElementById('modalTitle');
  const saveBtn = document.getElementById('saveBtn');
  
  // Resetear el formulario
  productName.value = '';
  productPrice.value = '';
  productImage.value = '';
  
  // Mostrar placeholder de imagen
  imagePreview.innerHTML = `
    <div id="imagePlaceholder" style="text-align: center; color: #999; padding: 20px;">
      <div style="font-size: 40px; margin-bottom: 10px;">üì∑</div>
      <div style="font-size: 14px; font-weight: 500;">Toca para agregar una foto</div>
      <div style="font-size: 12px; margin-top: 5px;">Recomendado: 800x600px</div>
    </div>
  `;
  
  removeImageBtn.style.display = 'none';
  
  // Cargar categor√≠as primero
  try {
    // Limpiar el select
    productCategory.innerHTML = '';
    
    // A√±adir opci√≥n por defecto
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Seleccionar categor√≠a';
    defaultOption.disabled = true;
    defaultOption.selected = true;
    productCategory.appendChild(defaultOption);
    
    // Cargar categor√≠as desde localStorage
    const categories = JSON.parse(localStorage.getItem('categories') || '[]');
    
    // A√±adir categor√≠as al select
    categories.forEach(category => {
      const option = document.createElement('option');
      option.value = category.name || category;
      option.textContent = category.name || category;
      productCategory.appendChild(option);
    });
  } catch (error) {
    console.error('Error al cargar categor√≠as:', error);
  }
  
  // Si se est√° editando un producto, cargar sus datos
  if (product) {
    modalTitle.textContent = 'Editar Producto';
    saveBtn.textContent = 'Actualizar';
    productName.value = product.title || product.name || '';
    productPrice.value = product.price || '';
    
    // Establecer la categor√≠a si existe
    if (product.category) {
      productCategory.value = product.category;
    }
    
    // Mostrar imagen si existe
    if (product.image) {
      imagePreview.style.backgroundImage = `url('${product.image}')`;
      imagePreview.querySelector('#imagePlaceholder').style.display = 'none';
      removeImageBtn.style.display = 'flex';
    }
  } else {
    modalTitle.textContent = 'Nuevo Producto';
    saveBtn.textContent = 'Guardar';
    // Asegurarse de que no hay imagen de fondo al crear un nuevo producto
    imagePreview.style.backgroundImage = 'none';
    // Asegurarse de que el placeholder sea visible
    const placeholder = imagePreview.querySelector('#imagePlaceholder');
    if (placeholder) {
      placeholder.style.display = 'block';
    }
  }
  
  // Mostrar el modal
  modal.style.display = 'flex';
  
  // Enfocar el primer campo
  setTimeout(() => {
    productName.focus();
  }, 100);
}

// Funci√≥n para eliminar la imagen
function removeImage(event) {
  if (event) event.stopPropagation();
  
  const imagePreview = document.getElementById('imagePreview');
  const imagePlaceholder = document.getElementById('imagePlaceholder');
  const removeImageBtn = document.getElementById('removeImageBtn');
  const productImage = document.getElementById('productImage');
  
  if (imagePreview) {
    imagePreview.style.backgroundImage = 'none';
    // Restaurar el placeholder si existe
    if (imagePlaceholder) {
      imagePlaceholder.style.display = 'flex';
    } else {
      // Si no existe el placeholder, crear uno
      imagePreview.innerHTML = `
        <div id="imagePlaceholder" style="text-align: center; color: #999; padding: 20px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
          <div style="font-size: 40px; margin-bottom: 10px;">üì∑</div>
          <div style="font-size: 14px; font-weight: 500;">Toca para agregar una foto</div>
          <div style="font-size: 12px; margin-top: 5px;">Recomendado: 800x600px</div>
        </div>
      `;
    }
  }
  
  if (removeImageBtn) removeImageBtn.style.display = 'none';
  if (productImage) productImage.value = '';
}

// Manejar la carga de im√°genes
const productImageInput = document.getElementById('productImage');
if (productImageInput) {
  productImageInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // Verificar si el archivo es una imagen
    if (!file.type.match('image.*')) {
      alert('Por favor, selecciona un archivo de imagen v√°lido');
      return;
    }
    
    const reader = new FileReader();
    
    reader.onload = function(event) {
      const imagePreview = document.getElementById('imagePreview');
      const imagePlaceholder = document.getElementById('imagePlaceholder');
      const removeImageBtn = document.getElementById('removeImageBtn');
      
      if (!imagePreview) return;
      
      // Establecer la imagen de fondo
      imagePreview.style.backgroundImage = `url('${event.target.result}')`;
      
      // Ocultar el placeholder si existe
      if (imagePlaceholder) {
        imagePlaceholder.style.display = 'none';
      } else {
        // Si no hay placeholder, limpiar cualquier contenido previo
        imagePreview.innerHTML = '';
      }
      
      // Mostrar el bot√≥n de eliminar
      if (removeImageBtn) {
        removeImageBtn.style.display = 'flex';
      }
    };
    
    reader.onerror = function() {
      console.error('Error al leer el archivo de imagen');
      alert('Error al cargar la imagen. Por favor, int√©ntalo de nuevo.');
    };
    
    // Leer el archivo como URL de datos
    reader.readAsDataURL(file);
  });
}

// Funci√≥n para guardar el producto
window.save = async function() {
  const title = document.getElementById('productName').value.trim();
  const price = document.getElementById('productPrice').value.trim();
  const category = document.getElementById('productCategory').value;
  const imgFile = document.getElementById('productImage').files[0];
  const editingId = document.getElementById('productModal').dataset.editingId;
  
  if (!title || !price) {
    alert('Por favor completa todos los campos obligatorios');
    return;
  }
  
  try {
    let imageUrl = '';
    
    // Si hay una imagen nueva, subirla
    if (imgFile) {
      imageUrl = await uploadToImgbb(imgFile);
    } else if (editingId) {
      // Si estamos editando y no hay imagen nueva, mantener la existente
      const existingProduct = products.find(p => p.id === editingId);
      if (existingProduct) {
        imageUrl = existingProduct.image;
      }
    }
    
    const productData = {
      title,
      price: parseFloat(price),
      category,
      ...(imageUrl && { image: imageUrl })
    };
    
    if (editingId) {
      // Actualizar producto existente
      await window.updateDoc(window.doc(db, "products", editingId), productData);
    } else {
      // Crear nuevo producto
      await window.addDoc(window.collection(db, "products"), productData);
    }
    
    // Cerrar el modal y actualizar la lista
    const modal = document.getElementById('productModal');
    modal.style.display = 'none';
    
    // Limpiar manualmente los campos del formulario
    document.getElementById('productName').value = '';
    document.getElementById('productPrice').value = '';
    document.getElementById('productCategory').value = '';
    const imagePreview = document.getElementById('imagePreview');
    if (imagePreview) {
      imagePreview.style.display = 'none';
      imagePreview.innerHTML = '';
    }
    document.getElementById('productModal').dataset.editingId = '';
    
    // Limpiar el input de imagen si existe
    const imageInput = document.getElementById('productImage');
    if (imageInput) {
      imageInput.value = '';
    }
    
    load();
  } catch (error) {
    console.error("Error al guardar el producto:", error);
    alert('Error al guardar el producto. Por favor, int√©ntalo de nuevo.');
  }
};

// Funci√≥n para buscar productos
const searchInput = document.getElementById('searchInput');
let searchTimeout;

searchInput.addEventListener('input', (e) => {
  clearTimeout(searchTimeout);
  const searchTerm = e.target.value.toLowerCase().trim();
  
  searchTimeout = setTimeout(() => {
    if (!searchTerm) {
      // Si el campo de b√∫squeda est√° vac√≠o, mostrar todos los productos
      displayProducts(products);
      return;
    }
    
    // Filtrar productos en memoria
    const filteredProducts = products.filter(product => {
      const title = product.title ? product.title.toLowerCase() : '';
      const category = product.category ? product.category.toLowerCase() : '';
      return title.includes(searchTerm) || category.includes(searchTerm);
    });
    
    // Mostrar productos filtrados
    displayProducts(filteredProducts);
    
    // Mostrar mensaje si no hay resultados
    if (filteredProducts.length === 0) {
      list.innerHTML = `
        <div style="text-align: center; padding: 20px; color: #666;">
          No se encontraron productos que coincidan con "${searchTerm}"
        </div>`;
    }
    }, 300); // Retraso de 300ms para evitar b√∫squedas innecesarias
  });
}); // Cierre del DOMContentLoaded
</script>

  <!-- Barra de navegaci√≥n -->
  <div class="nav-bar">
    <a href="index.html" class="nav-item">
      <div class="nav-icon">üè™</div>
      <span>Tienda</span>
    </a>
    <a href="admin.html" class="nav-item">
      <div class="nav-icon">‚öôÔ∏è</div>
      <span>Admin</span>
    </a>
    <a href="producto.html" class="nav-item active">
      <div class="nav-icon">üì¶</div>
      <span>Productos</span>
    </a>
  </div>
</body>
</html>

